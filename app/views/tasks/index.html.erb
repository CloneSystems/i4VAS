<%= link_to 'New Task', new_task_path %>
<hr />

<h2><%= link_to 'Tasks', root_path %></h2>

<!-- <div class="table">
	<div class="row">
		<div class="cell">
			<p>cell 1</p>
		</div>
		<div class="cell">
			<p>cell 2</p>
		</div>
	</div>
</div> -->

<table cellspacing="2" cellpadding="4">
  <tr style="text-align:left; vertical-align:bottom">
    <th>Actions</th>
    <th>Name</th>
    <th>Status</th>
    <!-- <th>Scan Config</th>
    <th>Scan Target</th> -->
    <th colspan="3">Reports</th>
    <th>Threat</th>
    <th>Trend</th>
  </tr>
	<tr>
		<th>&nbsp;</th>
		<th>&nbsp;</th>
		<th>&nbsp;</th>
		<th width="1">Total</th>
		<th>First</th>
		<th>Last</th>
		<th>&nbsp;</th>
		<th>&nbsp;</th>
	</tr>

<% @tasks.each do |task| %>
  <tr>
		<td>
			<div class="actions">
				<%# status: Delete Requested,Done,New,Pause Requested,Paused,Requested,Resume Requested,Running,Stop Requested,Stopped,Internal Error %>
				<% if ['New','Done'].include? task.status %>
						<%= link_to image_tag("start.png"), start_task_path(task.id), :title => 'Start Task' %>
				    <%= image_tag("resume_inactive.png") %>
				    <%= image_tag("stop_inactive.png") %>
				    <%= link_to image_tag("delete.png"), task_path(task.id), :title => 'Delete Task', :confirm => 'Are you sure?', :method => :delete %>
				<% elsif ['Stopped'].include? task.status %>
						<%= link_to image_tag("start.png"), start_task_path(task.id), :title => 'Start Task' %>
				    <%= link_to image_tag("resume.png"), resume_stopped_task_path(task.id), :title => 'Resume Task' %>
				    <%= image_tag("stop_inactive.png") %>
				    <%= link_to image_tag("delete.png"), task_path(task.id), :title => 'Delete Task', :confirm => 'Are you sure?', :method => :delete %>
				<% elsif ['Paused'].include? task.status %>
    				<%= image_tag("start_inactive.png") %>
				    <%= link_to image_tag("resume.png"), resume_paused_task_path(task.id), :title => 'Resume Task' %>
				    <%= link_to image_tag("stop.png"), stop_task_path(task.id), :title => 'Stop Task' %>
				    <%= link_to image_tag("delete.png"), task_path(task.id), :title => 'Delete Task', :confirm => 'Are you sure?', :method => :delete %>
				<% elsif ['Running'].include? task.status %>
    				<%= image_tag("start_inactive.png") %>
				    <%= link_to image_tag("pause.png"), pause_task_path(task.id), :title => 'Pause Task' %>
				    <%= link_to image_tag("stop.png"), stop_task_path(task.id), :title => 'Stop Task' %>
		    		<%= image_tag("delete_inactive.png") %>
				<% else %>
		    		<%= image_tag("start_inactive.png") %>
				    <%= image_tag("resume_inactive.png") %>
				    <%= image_tag("stop_inactive.png") %>
		    		<%= image_tag("delete_inactive.png") %>
				<% end %>
		    <%= link_to image_tag("details.png"), task_path(task.id), :title => 'Task Details' %>
		    <%= link_to image_tag("edit.png"), edit_task_path(task.id), :title => 'Edit Task' %>
			</div>
		</td>
    <td>
			<%= task.name %>
			<% unless task.comment.blank? %>
					<br />
					<%= truncate(task.comment, :length => 15) %>
			<% end %>
		</td>
    <td>
			<% if ['New','Done'].include?(task.status) || task.status =~ /Requested/ %>
					<%= task.status %>
			<% else %>
					<%= task.status %> at <%= task.overall_progress %>%
			<% end %>
		</td>
    <!-- <td><%#= task.config_name %></td>
    <td><%#= task.target_name %></td> -->
		<% lr = OpenvasCli::VasReport.get_by_id(task.last_report_id) %>
    <td><%= task.times_run %></td>
    <td>
			<%# openvas datetime as string: "Thu May 19 21:09:19 2011" %>
			<% frd = DateTime.strptime(task.first_report_date, "%a %b %d %H:%M:%S %Y") unless task.first_report_date.blank? %>
			<%= frd.strftime("%b %d %Y") unless task.first_report_date.blank? %>
		</td>
    <td>
			<%# openvas datetime as string: "Thu May 19 21:09:19 2011" %>
			<% lrd = DateTime.strptime(task.last_report_date, "%a %b %d %H:%M:%S %Y") unless task.last_report_date.blank? %>
			<%= lrd.strftime("%b %d %Y") unless task.last_report_date.blank? %>
		</td>
		<td>
			<%# threat: High, Medium, Low, Log, Debug ... where Log,Debug are shown as None %>
			<%
			max = nil
			threat = ''
			unless lr.blank?
				low = lr.result_count[:low][:total]
				max = low
				threat = 'Low'
				medium = lr.result_count[:medium][:total]
				max = medium if medium >= max
				threat = 'Medium' if medium >= max
				high = lr.result_count[:high][:total]
				max = high if high >= max
				threat = 'High' if high >= max
				threat = 'None' if threat == 0
			end
			%>
			<%= image_tag("#{threat.downcase}_big.png", :title => "threat is #{threat}") unless threat.blank? %>
		</td>
		<td>
			<% case %>
				<%# trend: up, down, more, less, same %>
				<% when ['same'].include?(task.trend) %>
						<%= image_tag("trend_nochange.png", :title => 'No change in Threat since last report') %>
				<% else %>
						<%= task.trend %>
			<% end %>
		</td>
  </tr>
	<!-- 
	<tr><td colspan="8"><pre><%#=OpenvasCli::VasTask.get_by_id(task.id).to_yaml%></pre></td></tr>
	<tr><td colspan="8"><pre><%#=lr.result_count.inspect unless lr.blank? %></pre></td></tr>
	<tr><td colspan="8"><pre><%#=lr.to_yaml%></pre></td></tr> 
	-->
	<tr><td colspan="8"><hr /></td></tr>
<% end %>
</table>